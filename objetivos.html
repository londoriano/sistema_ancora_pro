<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Meus Objetivos</title>
    <link href="style.css" rel="stylesheet">
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <style>
        .card-objetivo { transition: transform 0.2s; border-left: 5px solid #0d6efd; }
        .card-objetivo:hover { transform: translateY(-3px); }
        .bg-concluido { border-left-color: #198754 !important; background-color: #f8f9fa; opacity: 0.8; }
        .progress-height { height: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="alertaNaoSalvo" class="alert alert-warning text-center m-0 hidden">
        ‚ö†Ô∏è <strong>ALTERA√á√ïES PENDENTES!</strong> Salve antes de sair.
    </div>

    <nav class="navbar navbar-custom px-4 sticky-top">
        <div class="container-fluid">
            <button class="navbar-toggler bg-light me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand text-white" href="#" id="headerNomeCliente">Objetivos</a>
            <div class="d-flex gap-2 ms-auto">
                <button class="btn btn-success btn-sm fw-bold" onclick="salvarAlteracoes()"><i class="bi bi-save"></i> SALVAR</button>
                <button class="btn btn-outline-light btn-sm" onclick="voltarIndex()"><i class="bi bi-arrow-return-left"></i> Voltar</button>
            </div>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral">
        <div class="offcanvas-header bg-dark text-white">
            <h5 class="offcanvas-title"><i class="bi bi-menu-button-wide"></i> Navega√ß√£o</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column p-0" id="conteudoMenuLateral"></div>
    </div>

    <div class="container mt-4 mb-5 pb-5">
        
        <div class="row mb-4 align-items-end">
            <div class="col-md-8">
                <h4 class="section-title my-0">Mapa de Sonhos & Metas</h4>
                <small class="text-muted">Planejamento de curto, m√©dio e longo prazo.</small>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#modalObjetivo" onclick="prepararNovo()">
                    <i class="bi bi-plus-circle"></i> Novo Objetivo
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow-sm border-0 bg-light">
                    <div class="card-body d-flex justify-content-around text-center">
                        <div>
                            <h2 class="fw-bold text-primary mb-0" id="totalNecessario">R$ 0,00</h2>
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Custo Total dos Sonhos</small>
                        </div>
                        <div class="border-start ps-4">
                            <h2 class="fw-bold text-success mb-0" id="totalGuardado">R$ 0,00</h2>
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">J√° Conquistado</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="listaObjetivos" class="row g-3"></div>

    </div>

    <div class="modal fade" id="modalObjetivo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">Definir Meta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editIndex" value="-1">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">T√≠tulo do Objetivo *</label>
                        <input type="text" id="objTitulo" class="form-control" placeholder="Ex: Viagem Disney, Casa Pr√≥pria...">
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Prazo (Anos)</label>
                            <select id="objPrazo" class="form-select">
                                <option value="Curto">Curto (at√© 1 ano)</option>
                                <option value="M√©dio">M√©dio (2 a 5 anos)</option>
                                <option value="Longo">Longo (5+ anos)</option>
                                <option value="Aposentadoria">Aposentadoria</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Prioridade</label>
                            <select id="objPrioridade" class="form-select">
                                <option value="Alta">Alta</option>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Baixa">Baixa</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold text-primary">Valor Total (R$) *</label>
                            <input type="number" id="objValorTotal" class="form-control" placeholder="0.00">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label text-success">J√° Possui (R$)</label>
                            <input type="number" id="objValorAtual" class="form-control" placeholder="0.00">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold text-info"><i class="bi bi-piggy-bank"></i> Aporte Mensal (R$)</label>
                            <input type="number" id="objAporte" class="form-control" placeholder="0.00">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold text-success"><i class="bi bi-graph-up-arrow"></i> Rentabilidade (a.a.)</label>
                            <input type="number" id="objRentab" class="form-control" placeholder="Ex: 10" step="0.1">
                        </div>
                    </div>
                    <div class="form-text small mb-3 mt-0">Define o tempo real at√© a conquista com base nos juros compostos.</div>

                    <div class="mb-3">
                        <label class="form-label">Descri√ß√£o / Estrat√©gia</label>
                        <textarea id="objDesc" class="form-control" rows="2" placeholder="Detalhes de como atingir..."></textarea>
                    </div>

                    <div class="form-check form-switch bg-light p-2 rounded">
                        <input class="form-check-input ms-0 me-2" type="checkbox" id="objConcluido">
                        <label class="form-check-label fw-bold" for="objConcluido">Marcar como Realizado üéâ</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary w-100" onclick="salvarNovoObjetivo()">Salvar Meta</button>
                </div>
            </div>
        </div>
    </div>

    <script src="lib/chartjs/chart.min.js"></script>

    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script src="app.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const clientId = params.get('id');
        let listaObjetivos = [];
        let isDirty = false;
        const modalObj = new bootstrap.Modal(document.getElementById('modalObjetivo'));

        // Configura√ß√£o de inputs (sem negativos)
        document.querySelectorAll('input[type="number"]').forEach(i => {
            i.min = "0"; 
            i.addEventListener('input', function(){ if(this.value<0) this.value = Math.abs(this.value); });
        });

        function init() {
            if(!clientId) return exibirMensagem("Erro ID", "erro", () => voltarIndex());
            carregarDados();
            construirMenuLateral(clientId);
        }

        function carregarDados() {
            const db = getDB();
            const client = db.find(c => c.id === clientId);
            if (!client) return exibirMensagem("Cliente n√£o encontrado", "erro", () => voltarIndex());

            document.getElementById('headerNomeCliente').innerText = `Objetivos: ${client.nome}`;
            
            // --- MIGRA√á√ÉO AUTOM√ÅTICA DE DADOS (COM BLINDAGEM NaN) ---
            if (client.objetivosPlanejados && client.objetivosPlanejados.length > 0) {
                listaObjetivos = client.objetivosPlanejados.map(o => ({
                    ...o,
                    // Garante que sejam n√∫meros v√°lidos
                    valorTotal: Math.abs(parseFloat(o.valorTotal) || 0),
                    valorAtual: Math.abs(parseFloat(o.valorAtual) || 0)
                }));
            } 
            else if (client.objetivosDetalhados && client.objetivosDetalhados.length > 0) {
                listaObjetivos = client.objetivosDetalhados.map(o => ({
                    ...o,
                    valorTotal: Math.abs(parseFloat(o.valorTotal) || 0),
                    valorAtual: Math.abs(parseFloat(o.valorAtual) || 0)
                }));
                marcarComoSujo();
            }
            else if (client.dadosPessoais && client.dadosPessoais.listas && client.dadosPessoais.listas.objetivos) {
                listaObjetivos = client.dadosPessoais.listas.objetivos.map(o => ({
                    titulo: o.col1,
                    valorTotal: Math.abs(parseFloat(o.valor) || 0),
                    valorAtual: 0,
                    prazo: o.col3 || 'M√©dio',
                    prioridade: 'M√©dia',
                    descricao: 'Importado do cadastro r√°pido.',
                    concluido: false
                }));
                marcarComoSujo();
            } else {
                listaObjetivos = [];
            }
            
            renderizarTela();
            if(isDirty) document.getElementById('alertaNaoSalvo').classList.remove('hidden');
        }

function renderizarTela() {
            const container = document.getElementById('listaObjetivos');
            container.innerHTML = '';
            let total = 0, guardado = 0;
            
            if(!listaObjetivos.length) { container.innerHTML = '<div class="col-12 text-center text-muted py-5">Nenhum objetivo.</div>'; }
            
            listaObjetivos.forEach((obj, idx) => {
                const vTotal = parseFloat(obj.valorTotal) || 0;
                const vAtual = parseFloat(obj.valorAtual) || 0;
                const vAporte = parseFloat(obj.aporte) || 0; // Captura o aporte

                if(!obj.concluido) { total += vTotal; guardado += vAtual; }
                
                const pct = vTotal > 0 ? Math.min(100, (vAtual / vTotal) * 100).toFixed(0) : 0;
                const cor = pct >= 100 ? 'success' : (pct < 25 ? 'danger' : (pct < 75 ? 'warning' : 'primary'));
                
                const taxaAnual = parseFloat(obj.rentabilidade) || 0; // Se n√£o tiver, assume 0
                
                // L√ìGICA DE PREVIS√ÉO COM JUROS COMPOSTOS (NPER)
                let previsaoHtml = '<small class="text-muted"><i class="bi bi-hourglass"></i> Indefinido (sem aporte)</small>';
                
                const falta = vTotal - vAtual;

                if (vTotal <= vAtual) {
                    previsaoHtml = `<small class="text-success fw-bold"><i class="bi bi-check-all"></i> Atingido!</small>`;
                } 
                else if (vAporte > 0) {
                    let meses;
                    
                    if (taxaAnual === 0) {
                        // C√°lculo linear simples (sem juros)
                        meses = Math.ceil(falta / vAporte);
                    } else {
                        // C√°lculo Logar√≠tmico (Juros Compostos)
                        // F√≥rmula NPER: n = ln((FV * i + PMT) / (PV * i + PMT)) / ln(1 + i)
                        const taxaMensal = (Math.pow(1 + (taxaAnual / 100), 1/12)) - 1;
                        
                        // Numerador do Log
                        const num = (vTotal * taxaMensal) + vAporte;
                        const den = (vAtual * taxaMensal) + vAporte;
                        
                        // Prote√ß√£o matem√°tica
                        if (den === 0 || num / den <= 0) {
                            meses = 9999; // Erro matem√°tico (imposs√≠vel atingir)
                        } else {
                            meses = Math.ceil(Math.log(num / den) / Math.log(1 + taxaMensal));
                        }
                    }

                    const anos = (meses / 12).toFixed(1);
                    const textoTempo = meses <= 12 ? `${meses} meses` : `${anos} anos`;
                    
                    // Diferenciar visualmente se est√° usando juros ou n√£o
                    const icone = taxaAnual > 0 ? 'bi-graph-up-arrow' : 'bi-clock-history';
                    const title = taxaAnual > 0 ? `Considerando rentabilidade de ${taxaAnual}% a.a.` : 'Considerando juros zero';
                    
                    previsaoHtml = `<small class="text-primary fw-bold" title="${title}"><i class="bi ${icone}"></i> Meta: ${textoTempo}</small>`;
                }

                container.innerHTML += `
                <div class="col-md-6 col-lg-4">
                    <div class="card shadow-sm h-100 card-objetivo ${obj.concluido?'bg-concluido':''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <h5 class="fw-bold mb-0 text-truncate" title="${obj.titulo}">${obj.titulo}</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="editarObjetivo(${idx})">Editar</a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="excluirObjetivo(${idx})">Excluir</a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between small text-muted mb-2">
                                <span>Aporte: <strong>${formatarMoeda(vAporte)}</strong></span>
                                <span>Prioridade: ${obj.prioridade || 'M√©dia'}</span>
                            </div>

                            <div class="progress mb-2" style="height:10px;"><div class="progress-bar bg-${cor}" style="width:${pct}%"></div></div>
                            
                            <div class="d-flex justify-content-between small fw-bold mb-2">
                                <span>${pct}%</span><span>${formatarMoeda(vTotal)}</span>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2">
                                <div class="small text-muted">Atual: ${formatarMoeda(vAtual)}</div>
                                ${previsaoHtml}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            document.getElementById('totalNecessario').innerText = formatarMoeda(total);
            document.getElementById('totalGuardado').innerText = formatarMoeda(guardado);
        }

        function salvarNovoObjetivo() {
            const titulo = document.getElementById('objTitulo').value;
            const total = parseFloat(document.getElementById('objValorTotal').value);
            
            if (!titulo || isNaN(total)) return exibirMensagem("T√≠tulo e Valor s√£o obrigat√≥rios", "aviso");

            const index = parseInt(document.getElementById('editIndex').value);
            const novo = {
                titulo, 
                valorTotal: Math.abs(total),
                valorAtual: Math.abs(parseFloat(document.getElementById('objValorAtual').value)||0),
                // ADICIONE ESTA LINHA:
                aporte: Math.abs(parseFloat(document.getElementById('objAporte').value)||0),
                rentabilidade: Math.abs(parseFloat(document.getElementById('objRentab').value)||0), // <--- NOVO
                prazo: document.getElementById('objPrazo').value,
                prioridade: document.getElementById('objPrioridade').value,
                descricao: document.getElementById('objDesc').value,
                concluido: document.getElementById('objConcluido').checked
            };

            if(index === -1) listaObjetivos.push(novo);
            else listaObjetivos[index] = novo;

            marcarComoSujo();
            renderizarTela();
            modalObj.hide();
        }

        function salvarAlteracoes(silencioso = false) {
            const db = getDB();
            const idx = db.findIndex(c => c.id === clientId);
            if (idx !== -1) {
                db[idx].objetivosPlanejados = listaObjetivos;
                delete db[idx].objetivosDetalhados; 
                saveDB(db);
                isDirty = false;
                document.getElementById('alertaNaoSalvo').classList.add('hidden');
                if (!silencioso) exibirMensagem("Objetivos salvos!", "sucesso");
            }
        }
        
        function prepararNovo() { 
            document.getElementById('editIndex').value = -1; 
            document.getElementById('objTitulo').value = "";
            document.getElementById('objValorTotal').value = "";
            document.getElementById('objValorAtual').value = "";
            document.getElementById('objAporte').value = ""; // <--- ADICIONE ISTO
            document.getElementById('objRentab').value = "10"; // Sugest√£o padr√£o: 10% a.a.
            document.getElementById('objDesc').value = "";
            document.getElementById('modalTitulo').innerText = "Novo Objetivo";
        }
        
        function editarObjetivo(i) {
            const o = listaObjetivos[i];
            document.getElementById('editIndex').value = i;
            document.getElementById('objTitulo').value = o.titulo;
            document.getElementById('objValorTotal').value = o.valorTotal;
            document.getElementById('objValorAtual').value = o.valorAtual;
            // ADICIONE ESTA LINHA:
            document.getElementById('objAporte').value = o.aporte || "";
            document.getElementById('objRentab').value = o.rentabilidade !== undefined ? o.rentabilidade : 10; // <--- NOVO
            document.getElementById('objPrazo').value = o.prazo;
            document.getElementById('objPrioridade').value = o.prioridade;
            document.getElementById('objDesc').value = o.descricao;
            document.getElementById('objConcluido').checked = o.concluido;
            document.getElementById('modalTitulo').innerText = "Editar";
            modalObj.show();
        }
        
        function excluirObjetivo(i) { 
            exibirConfirmacao("Excluir?", () => { listaObjetivos.splice(i,1); marcarComoSujo(); renderizarTela(); }); 
        }
        
        function marcarComoSujo() { isDirty = true; document.getElementById('alertaNaoSalvo').classList.remove('hidden'); }
        function voltarIndex() { navegarPara('clientes.html'); }

        init();
    </script>
</body>
</html>